name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # master
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --check

  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # master
        with:
          toolchain: stable
          components: clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Run unit tests
        run: cargo test -p lambda-otel-relay

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # master
        with:
          toolchain: stable

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@abea47f85e598557f500fa1fd2ab7464fcb39406 # v2.2.1
        with:
          version: 0.13.0

      - name: Install cargo-lambda
        uses: zerj9/setup-cargo-lambda@0e3fc757cbb70387ecba326fd28ab729c2a5ce7a # v0.1.2

      - name: Cache dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Build extension
        run: cargo lambda build --release -p lambda-otel-relay --extension

      - name: Build telemetry proxy
        run: cargo lambda build --release -p telemetry-proxy

      - name: Build test handler
        run: cargo lambda build --release -p test-handler

      - name: Build mock-rie image
        run: |
          mkdir -p target/mock-rie-context
          cp target/lambda/telemetry-proxy/bootstrap target/mock-rie-context/telemetry-proxy
          cp tests/fixtures/mock-rie/ext-wrapper.sh target/mock-rie-context/
          cp tests/fixtures/mock-rie/entrypoint.sh target/mock-rie-context/
          docker build -t mock-rie:latest -f tests/fixtures/mock-rie/Dockerfile target/mock-rie-context/

      - name: Run integration tests
        run: cargo test --test '*' -- --nocapture
